#!/bin/bash
#
# $Id: setup-knockd 93 2016-10-06 12:12:35+04:00 toor $
#
_bashlyk=kurenma . bashlyk
#
#
#
udfMain() {

	udfExitIfAlreadyStarted

	[[ $UID == 0 ]] || eval $( udfOnError throw iErrorNotPermitted "You must be root to run this." )

	udfThrowOnCommandNotFound cat grep sed

	local crtServer cnServer fmtKnockd iniServer iniKnockd pathIni s
	fmtKnockd="sequence=%d,%d,%d;seq_timeout=5;command=/usr/bin/update-firehol %%IP%%;tcpflags=syn"

	pathIni=$( _ pathIni )
	iniServer=${pathIni}/kurenma.ini
	iniKnockd="/etc/knockd.conf"
	#
	udfIni $iniServer "ssl:cnServer"
	udfThrowOnEmptyVariable cnServer

	crtServer=${pathIni}/ssl/public/${cnServer}.crt

	[[ -s $crtServer ]] || eval $( udfOnError throw iErrorNoSuchFileOrDir $crtServer )

	s=$(grep keyid $crtServer | sed -r -e "s/^.*keyid:(..):(..):(..):(..):(..):(..):.*$/0x\1\2 0x\3\4 0x\5\6/")
	udfDebug 2 "keyid head: $s"
	s=$( printf -- "$fmtKnockd" $s )
	udfDebug 2 "  sequence: $s"

	udfIniChange $iniKnockd "$s" "kurenma"

	udfDebug 2 && cat $iniKnockd

	if systemctl >/dev/null 2>&1; then

		systemctl restart knockd.service

	else

		service knockd restart

	fi

	udfFinally "service down"

}
#
#
#
udfMain
#


